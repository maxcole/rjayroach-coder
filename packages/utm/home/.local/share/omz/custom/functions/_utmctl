#compdef utmctl

_utmctl() {
    local -a commands
    commands=(
        'list:Enumerate all registered virtual machines'
        'status:Query the status of a virtual machine'
        'start:Start a virtual machine or resume a suspended virtual machine'
        'suspend:Suspend running a virtual machine to memory'
        'stop:Shut down a running virtual machine'
        'attach:Redirect console output'
        'exec:Execute commands in the VM'
        'ip-address:List all IP addresses associated with network interfaces'
        'clone:Clone an existing virtual machine'
        'delete:Delete a virtual machine'
        'usb:Connect and disconnect USB devices'
    )

    local -a vm_names
    # Get VM names from utmctl list (cache for performance)
    if [[ -z "$_utmctl_vm_cache" ]] || [[ $(( $(date +%s) - ${_utmctl_vm_cache_time:-0} )) -gt 30 ]]; then
        _utmctl_vm_cache=(${(f)"$(utmctl list 2>/dev/null | tail -n +2 | awk '{print $3}' 2>/dev/null)"})
        _utmctl_vm_cache_time=$(date +%s)
    fi
    vm_names=($_utmctl_vm_cache)

    if (( CURRENT == 2 )); then
        _describe 'commands' commands
    elif (( CURRENT == 3 )); then
        case $words[2] in
            start|stop|status|suspend|delete|ip-address|attach|exec)
                _describe 'virtual machines' vm_names
                ;;
            clone)
                _describe 'source virtual machine' vm_names
                ;;
            usb)
                _values 'usb commands' 'connect' 'disconnect' 'list'
                ;;
        esac
    elif (( CURRENT == 4 )); then
        case $words[2] in
            clone)
                _message 'new VM name'
                ;;
        esac
    fi
}

_utmctl "$@"
