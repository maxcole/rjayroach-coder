#!/usr/bin/env ruby

require 'thor'
require 'webrick'
require 'yaml'
require 'erb'
require 'socket'

class Builder < Thor
  def self.exit_on_failure? = true

  desc "serve NAME", "Serve preseed.cfg for the given configuration name"
  option :port, type: :numeric, default: 8080, aliases: '-p'
  def serve(name)
    config_dir = File.expand_path("~/.config/builder")
    config_file = File.join(config_dir, "#{name}.yml")
    template_file = File.join(config_dir, "preseed.cfg.erb")

    unless File.exist?(config_file)
      puts "Config not found: #{config_file}"
      exit 1
    end

    config = YAML.load_file(config_file, symbolize_names: true)
    template = ERB.new(File.read(template_file))
    preseed_content = template.result_with_hash(config)

    ip = local_ip
    port = options[:port]
    preseed_path = "/preseed-#{name}.cfg"

    puts "Serving preseed at: http://#{ip}:#{port}#{preseed_path}"
    puts "Boot param: auto=true priority=critical preseed/url=http://#{ip}:#{port}#{preseed_path}"
    puts "\nPress Ctrl+C to stop\n\n"

    server = WEBrick::HTTPServer.new(Port: port, Logger: WEBrick::Log.new($stdout, WEBrick::Log::INFO))

    server.mount_proc(preseed_path) do |req, res|
      res['Content-Type'] = 'text/plain'
      res.body = preseed_content
    end

    trap('INT') { server.shutdown }
    server.start
  end

  desc "repack NAME", "Repack a Debian ISO with preseed URL baked into GRUB"
  option :iso, type: :string, required: true, aliases: '-i', desc: 'Path to original Debian ISO'
  option :output, type: :string, aliases: '-o', desc: 'Output ISO path'
  option :port, type: :numeric, default: 8080, aliases: '-p'
  def repack(name)
    require 'fileutils'

    iso_path = File.expand_path(options[:iso])
    output_path = options[:output] || iso_path.sub(/\.iso$/, "-#{name}.iso")
    ip = local_ip
    port = options[:port]
    preseed_url = "http://#{ip}:#{port}/preseed-#{name}.cfg"

    unless File.exist?(iso_path)
      puts "ISO not found: #{iso_path}"
      exit 1
    end

    puts "Preseed URL: #{preseed_url}"
    puts "Repacking ISO..."

    if linux?
      repack_native(iso_path, output_path, preseed_url)
    else
      repack_container(iso_path, output_path, preseed_url)
    end

    puts "\nCreated: #{output_path}"
    puts "Remember to run: builder serve #{name}"
  end

  private

  def linux?
    RUBY_PLATFORM.include?('linux')
  end

  def local_ip
    Socket.ip_address_list
          .detect { |addr| addr.ipv4? && !addr.ipv4_loopback? }
          &.ip_address || '127.0.0.1'
  end

  def container_runtime
    @container_runtime ||= begin
      %w[podman docker].find { |cmd| system("which #{cmd} > /dev/null 2>&1") } ||
        abort("No container runtime found. Install podman or docker.")
    end
  end

  def ensure_container_running
    return unless container_runtime == 'podman' && !linux?

    unless system("podman machine list --format '{{.Name}}' | grep -q podman-machine-default")
      puts "Initializing podman machine..."
      system("podman machine init")
    end

    unless system("podman machine list --format '{{.Running}}' | grep -q true")
      puts "Starting podman machine..."
      system("podman machine start")
    end
  end

  def repack_native(iso_path, output_path, preseed_url)
    %w[xorriso isolinux].each do |pkg|
      unless system("which #{pkg} > /dev/null 2>&1") || File.exist?("/usr/lib/ISOLINUX/isohdpfx.bin")
        abort("Missing #{pkg}. Install with: apt install xorriso isolinux")
      end
    end

    work_dir = "/tmp/iso-repack-#{$$}"
    FileUtils.mkdir_p(work_dir)

    begin
      system("xorriso -osirrox on -indev #{iso_path} -extract / #{work_dir}/iso") || abort("Failed to extract ISO")
      system("chmod -R u+w #{work_dir}/iso")

      patch_grub_config("#{work_dir}/iso", preseed_url)

      system(<<~CMD) || abort("Failed to create ISO")
        xorriso -as mkisofs \
          -o #{output_path} \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -c isolinux/boot.cat \
          -b isolinux/isolinux.bin \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -eltorito-alt-boot \
          -e boot/grub/efi.img \
          -no-emul-boot -isohybrid-gpt-basdat \
          #{work_dir}/iso
      CMD
    ensure
      FileUtils.rm_rf(work_dir)
    end
  end

  def repack_container(iso_path, output_path, preseed_url)
    ensure_container_running

    iso_dir = File.dirname(iso_path)
    iso_name = File.basename(iso_path)
    output_name = File.basename(output_path)

    script = <<~BASH
      set -e
      apt-get update && apt-get install -y xorriso isolinux

      mkdir -p /tmp/iso
      xorriso -osirrox on -indev /work/#{iso_name} -extract / /tmp/iso
      chmod -R u+w /tmp/iso

      sed -i 's|\\(linux.*---.*quiet\\)|\\1 auto=true priority=critical preseed/url=#{preseed_url}|g' /tmp/iso/boot/grub/grub.cfg
      sed -i 's|\\(append.*---.*quiet\\)|\\1 auto=true priority=critical preseed/url=#{preseed_url}|g' /tmp/iso/isolinux/isolinux.cfg 2>/dev/null || true

      xorriso -as mkisofs \
        -o /work/#{output_name} \
        -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
        -c isolinux/boot.cat \
        -b isolinux/isolinux.bin \
        -no-emul-boot -boot-load-size 4 -boot-info-table \
        -eltorito-alt-boot \
        -e boot/grub/efi.img \
        -no-emul-boot -isohybrid-gpt-basdat \
        /tmp/iso
    BASH

    system("#{container_runtime} run --rm -v #{iso_dir}:/work debian:bookworm bash -c #{script.shellescape}") ||
      abort("Failed to repack ISO in container")
  end

  def patch_grub_config(iso_dir, preseed_url)
    grub_cfg = "#{iso_dir}/boot/grub/grub.cfg"
    if File.exist?(grub_cfg)
      content = File.read(grub_cfg)
      modified = content.gsub(
        /(linux\s+\/install\.amd\/vmlinuz.*?---.*?quiet)/,
        "\\1 auto=true priority=critical preseed/url=#{preseed_url}"
      )
      File.write(grub_cfg, modified)
    end

    isolinux_cfg = "#{iso_dir}/isolinux/isolinux.cfg"
    if File.exist?(isolinux_cfg)
      content = File.read(isolinux_cfg)
      modified = content.gsub(
        /(append.*?---.*?quiet)/,
        "\\1 auto=true priority=critical preseed/url=#{preseed_url}"
      )
      File.write(isolinux_cfg, modified)
    end
  end
end

Builder.start(ARGV)
